'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.CloudinaryUploadStatus=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _wrapDisplayName=require('recompose/wrapDisplayName');var _wrapDisplayName2=_interopRequireDefault(_wrapDisplayName);var _lpRequests=require('@launchpadlab/lp-requests');var _utils=require('./utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var CloudinaryUploadStatus=exports.CloudinaryUploadStatus={LOADING:'uploading',SUCCESS:'upload-success',FAILURE:'upload-failure'};var DEFAULT_ENDPOINT='https://api.cloudinary.com/v1_1';var DEFAULT_FILE_TYPE='auto';var DEFAULT_UPLOAD_PRESET='default';var DEFAULT_REQUEST_OPTIONS={headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest','Content-Type':'application/json'},mode:'cors'};function createPublicId(file,publicId){var type=file.type,name=file.name;var isImageType=(0,_utils.first)(type.split('/'))==='image';var isPdfType=type==='application/pdf';var fileName=publicId||name;return isPdfType||isImageType?(0,_utils.removeExtension)(fileName):(0,_utils.addExtension)(fileName,file)}function cloudinaryUploader(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return function(Wrapped){var _class,_temp;return _temp=_class=function(_Component){_inherits(Wrapper,_Component);function Wrapper(props){_classCallCheck(this,Wrapper);var _this=_possibleConstructorReturn(this,(Wrapper.__proto__||Object.getPrototypeOf(Wrapper)).call(this,props));var config=_extends({},options,props);var _config$cloudName=config.cloudName,cloudName=_config$cloudName===undefined?(0,_utils.getEnvVar)('CLOUDINARY_CLOUD_NAME')||(0,_utils.requireParam)('cloudName','cloudinaryUploader'):_config$cloudName,_config$bucket=config.bucket,bucket=_config$bucket===undefined?(0,_utils.getEnvVar)('CLOUDINARY_BUCKET')||(0,_utils.requireParam)('bucket','cloudinaryUploader'):_config$bucket,_config$uploadPreset=config.uploadPreset,uploadPreset=_config$uploadPreset===undefined?(0,_utils.getEnvVar)('CLOUDINARY_UPLOAD_PRESET')||DEFAULT_UPLOAD_PRESET:_config$uploadPreset,_config$endpoint=config.endpoint,endpoint=_config$endpoint===undefined?(0,_utils.getEnvVar)('CLOUDINARY_ENDPOINT')||DEFAULT_ENDPOINT:_config$endpoint,_config$fileType=config.fileType,fileType=_config$fileType===undefined?DEFAULT_FILE_TYPE:_config$fileType,_config$requestOption=config.requestOptions,requestOptions=_config$requestOption===undefined?DEFAULT_REQUEST_OPTIONS:_config$requestOption,cloudinaryPublicId=config.cloudinaryPublicId;_this.cloudinaryRequest=function(fileData,file){var publicId=createPublicId(file,cloudinaryPublicId);var setPublicId=cloudinaryPublicId||fileType===DEFAULT_FILE_TYPE;var url=endpoint+'/'+cloudName+'/'+fileType+'/upload';var body=_extends({file:fileData,folder:bucket,uploadPreset:uploadPreset},setPublicId&&{publicId:publicId});return _lpRequests.api.post(url,body,requestOptions)};_this.upload=_this.upload.bind(_this);_this.state={uploadStatus:''};return _this}_createClass(Wrapper,[{key:'upload',value:function upload(fileData,file){var _this2=this;this.setState({uploadStatus:CloudinaryUploadStatus.LOADING});return this.cloudinaryRequest(fileData,file).then(function(res){_this2.setState({uploadStatus:CloudinaryUploadStatus.SUCCESS});return res}).catch(function(error){_this2.setState({uploadStatus:CloudinaryUploadStatus.FAILURE});throw error})}},{key:'render',value:function render(){var uploadStatus=this.state.uploadStatus;return _react2.default.createElement(Wrapped,_extends({upload:this.upload,uploadStatus:uploadStatus},this.props))}}]);return Wrapper}(_react.Component),_class.displayName=(0,_wrapDisplayName2.default)(Wrapped,'cloudinaryUploader'),_temp}}exports.default=cloudinaryUploader;