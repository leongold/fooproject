'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _utils=require('../utils');var _LP_API=require('../LP_API');var _LP_API2=_interopRequireDefault(_LP_API);var _actions=require('../actions');var actions=_interopRequireWildcard(_actions);var _parseAction=require('./parse-action');var _parseAction2=_interopRequireDefault(_parseAction);var _parseOptions3=require('./parse-options');var _parseOptions4=_interopRequireDefault(_parseOptions3);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var DEFAULT_CONFIG_OPTIONS={onUnauthorized:null};var DEFAULT_REQUEST_OPTIONS={credentials:'same-origin',csrf:true,mode:'same-origin'};function createStubHttp(data){return function http(){return Promise.resolve(data)}}function middleware(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _parseOptions=(0,_parseOptions4.default)(options),configOptions=_parseOptions.configOptions,requestOptions=_parseOptions.requestOptions;var defaultConfigOptions=_extends({},DEFAULT_CONFIG_OPTIONS,configOptions);var defaultRequestOptions=_extends({},DEFAULT_REQUEST_OPTIONS,requestOptions);var baseHttp=(0,_utils.configureHttp)(defaultRequestOptions);return function(){return function(next){return function(action){if(!action)return;var options=action[_LP_API2.default];if(!options)return next(action);var _parseOptions2=(0,_parseOptions4.default)(options),configOptions=_parseOptions2.configOptions,requestOptions=_parseOptions2.requestOptions,url=_parseOptions2.url;var mergedConfigOptions=_extends({},defaultConfigOptions,configOptions);var onUnauthorized=mergedConfigOptions.onUnauthorized,requestKey=mergedConfigOptions.requestKey,requestAction=mergedConfigOptions.requestAction,successAction=mergedConfigOptions.successAction,failureAction=mergedConfigOptions.failureAction,isStub=mergedConfigOptions.isStub,stubData=mergedConfigOptions.stubData;if(!isStub&&!url)throw new Error('Middleware: Must provide string \'url\' argument');if(requestAction){next((0,_parseAction2.default)({action:requestAction,payload:options}))}if(requestKey)next(actions.setStatusLoading(requestKey));var http=isStub?createStubHttp(stubData):baseHttp;return http(url,requestOptions).then(function(response){if(successAction){next((0,_parseAction2.default)({action:successAction,payload:response}))}if(requestKey)next(actions.setStatusSuccess(requestKey,response));return response},function(error){if(failureAction){next((0,_parseAction2.default)({action:failureAction,payload:error,error:true}))}if(requestKey)next(actions.setStatusFailure(requestKey,error));if(error.status===401&&onUnauthorized)next(onUnauthorized({error:error,request:options}));throw error})}}}}exports.default=middleware;